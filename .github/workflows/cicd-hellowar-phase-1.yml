
name: CI/CD - HelloWar (Phase-1)
run-name: >
  ${{ github.event.inputs.run_description != '' && github.event.inputs.run_description || 'Manual Trigger' }}


on:
  workflow_dispatch:
    inputs:
      run_description:
        description: 'Description of this run'
        required: false
        default: 'Manual Trigger'
      skip_sonar:
        description: 'Skip SonarCloud Scan?'
        type: boolean
        required: false
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JFROG_USER: ${{ secrets.JFROG_USER_CI }}
      JFROG_TOKEN: ${{ secrets.JFROG_TOKEN_CI }}


    steps:
      - name: Show run description
        run: | #multi-line due to yaml parser being picky of : after description
          echo "Run Description: ${{ github.event.inputs.run_description }}"
          echo "Skip SonarCloud Scan: ${{ github.event.inputs.skip_sonar }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history for SonarQube analysis
          
         
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          # This will be used for across runs in this repo so initially disable to test Artifactory Cache.
          cache: maven


      - name: Write Maven settings (.m2/settings.xml)
        run: |
          mkdir -p $HOME/.m2
          cat > $HOME/.m2/settings.xml <<'XML'
          <settings>
            <servers>

              <!-- Read (downloads) via virtual -->
              <server>
                <id>maven-all</id>
                <username>${env.JFROG_USER}</username>
                <password>${env.JFROG_TOKEN}</password>
              </server>

              <server>
                <id>devopsbyte-maven-releases</id>
                <username>${env.JFROG_USER}</username>
                <password>${env.JFROG_TOKEN}</password>
              </server>

              <server>
                <id>devopsbyte-maven-snapshots</id>
                <username>${env.JFROG_USER}</username>
                <password>${env.JFROG_TOKEN}</password>
              </server>

            </servers>

            <mirrors>
              <mirror>
                <id>maven-all</id>
                <url>https://devopsbyte.jfrog.io/artifactory/maven-all</url>
                <mirrorOf>*</mirrorOf>
              </mirror>
            </mirrors>
          </settings>
          XML


      - name: Check Maven cache after restore
        run: |
          echo "After setup-java restore:"
          du -sh ~/.m2/repository || echo "No Maven cache restored."

          echo "--------------------------------------------"
          echo "~/.m2/repository contents (first 50 lines):"
          ls -R ~/.m2/repository | head -50 || true

          echo "--------------------------------------------"
          echo "~/.m2/ contents:"
          ls -l ~/.m2/

          echo "--------------------------------------------"
          echo "settings.xml contents:"
          cat ~/.m2/settings.xml || echo "No settings.xml"
          


      - name: Run unit tests
        run: mvn -B -ntp clean test

      
      - name: SonarCloud Scan
        #if: always() # continue even if previous steps fail (like tests)
        if: ${{ github.event.inputs.skip_sonar != 'true' }}
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ vars.SONAR_ORG }}
        run: |
          mvn -B -ntp verify sonar:sonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=$SONAR_ORG \
            -Dsonar.projectKey=$SONAR_PROJECT_KEY \
            -Dsonar.login=${SONAR_TOKEN}

            # Note: we are NOT using sonar.qualitygate.wait=true in Phase-1.


      - name: Package WAR
        run: mvn -B -ntp -DskipTests package


      - name: Show artifact
        run: ls -l target/*.war || true


      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: hello-war                  # constant, easy to download later
          path: target/*.war
          if-no-files-found: error
          retention-days: 14



      - name: Ship Artifact
        run: mvn -B -ntp -DskipTests deploy


  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      ARTIFACTORY_URL: ${{ vars.JFROG_URL }}
      ARTIFACTORY_REPO: ${{ vars.JFROG_REPO }}
      ARTIFACT_GROUP_PATH: ${{ vars.JFROG_ARTIFACT_GROUP_PATH }}
      ARTIFACT_ID: ${{ vars.JFROG_ARTIFACT_ID }}
      ARTIFACT_BASE_VERSION: ${{ vars.JFROG_ARTIFACT_BASE_VER }}
      ARTIFACTORY_USER: ${{ secrets.JFROG_USER_CI  }}
      ARTIFACTORY_TOKEN: ${{ secrets.JFROG_TOKEN_CI  }}
      
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          
      - name: Get EC2 IP dynamically
        id: get_ip
        uses: devopsbyte-internal/cicd-actions/.github/actions/get-ec2-ip@main
        with:
          instance-tag: "hellowar-tomcat-be"
          aws-region: "us-east-1"

      - name: Set EC2 host env
        run: echo "EC2_HOST=${{ steps.get_ip.outputs.ec2_ip }}" >> $GITHUB_ENV
        
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Run deploy.sh on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.EC2_USER }}@$EC2_HOST \
            "sudo ARTIFACTORY_URL='$ARTIFACTORY_URL' \
                  ARTIFACTORY_REPO='$ARTIFACTORY_REPO' \
                  ARTIFACT_GROUP_PATH='$ARTIFACT_GROUP_PATH' \
                  ARTIFACT_ID='$ARTIFACT_ID' \
                  ARTIFACT_BASE_VERSION='$ARTIFACT_BASE_VERSION' \
                  ARTIFACTORY_USER='$ARTIFACTORY_USER' \
                  ARTIFACTORY_TOKEN='$ARTIFACTORY_TOKEN' \
                  /opt/deploy/deploy.sh '${{ github.event.inputs.deploy_version }}'"
